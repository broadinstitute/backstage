# MediaWiki Configuration

After [Terraform][1] sets up the cloud resources to host the [MediaWiki][2]
installation, more steps are needed to finish the configuration and get the site
running. This document will walk you through the steps needed to complete the
setup of the [MediaWiki][2] site.

## MySQL database

[Terraform][1] creates a MySQL [Google Cloud SQL][3] instance. It then creates a
`mediawiki` database and `mediawiki` user in that instance. To complete this
process, you will also need a file from a database administrator with the latest
backup of your existing [MediaWiki][2] database.

### User password

The user gets a random password set on creation that you can retrieve from the
[Terraform][1] state using the following command:

```Shell
terraform state show random_id.db_user_password
```

The password will be the `hex` value in the output. Save this value for later.

### Service Account credentials

[Terraform][1] grants the service account used for this [MediaWiki][2] container
access to the [Google Cloud SQL][3] database. In order to connect to the
database remotely to upload a dump of the current database, you will need these
credentials to set up a [Cloud SQL Proxy][4] connection. You can retrieve a JSON
file with the credentials using a `gcloud` command.

```Shell
gcloud iam \
    --project ${{ values.gcpProject }} service-accounts keys create mediawiki.json \
    --iam-account='sa-mediawiki@${{ values.gcpProject }}.iam.gserviceaccount.com'
```

Note that the project name is specified in the `--project` flag **and** in the
name in the `--iam-account` flag.

This will create a file named `mediawiki.json` that you will use in the next
step to connect the [Cloud SQL Proxy][4].

### Cloud SQL Proxy

Once you have this information, you should be able to run the `cloud-sql-proxy`
container to establish a connection to the [Google Cloud SQL][3] database. The
following script can be created to easily start up the proxy and have it listen
on the default MySQL port (`3306`).

```Shell
#!/usr/bin/env bash

KEY_FILE_PATH='/path/to/mediawiki.json'
INSTANCE_CONNECTION_NAME='${{ values.gcpProject }}:${{ values.gcpRegion }}:${{ values.name }}-mediawiki-abcdef123'

podman run --detach \
  --volume "${KEY_FILE_PATH}:/auth/service-account-key.json" \
  --publish '127.0.0.1:3306:3306' \
  gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.16.0 \
  --address 0.0.0.0 \
  --credentials-file /auth/service-account-key.json "${INSTANCE_CONNECTION_NAME}"
```

In the above script, you will need to make some updates:

- `KEY_FILE_PATH`: Update with the correct path to your `mediawiki.json` file.
- `INSTANCE_CONNECTION_NAME`: Make sure the correct project name, region, and
  database instance name are correct. The example uses `abcdef123` in the name
  because the Terraform uses a random string here, so that will need to be
  updated to the correct value. This full string should appear in the output for
  `cloudsql_connection_name` when you run the following [Terraform][1] command:

```Shell
terraform output
```

### Connect to the database and import the database

For your existing site, you should have a file that is a dump of the database
generated by a database administrator. For this example, we will name the file
`db_backup`. You should now be able to authenticate through the proxy to the
[Google Cloud SQL][3] database and then upload this database backup to restore
the database to its new location.

```Shell
mysql --host 127.0.0.1 --user mediawiki --password
```

You will be prompted for the password. Enter the password you retrieved from the
`terraform state show random_id.db_user_password` command earlier.

You should see a response similar to the following:

```Text
Enter password:
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 3321
Server version: 8.0.40-google (Google)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [mediawiki]>
```

You should then be able to import the database to restore it to [Google Cloud
SQL][3]:

```Shell
\. db_backup
```

This will output progress lines until all the tables have been recreated and
updated.

## Data files

In a standard [MediaWiki][2] conversion, you will have one storage bucket that
is created. You can find the name in the `storage_bucket` output when you run
the following [Terraform][1] command:

```Shell
terraform output
```

The files and folders that need to be uploaded to the bucket are usually:

- `LocalSettings.php`: This file will also need to be modified at a later point,
  so you will need a local copy that you may have to upload several times to
  correct errors.
- `images/`: The folder where all uploaded images are stored.
- `extensions/??`: If you have any non-standard extensions in use by your wiki,
  those folders will need to be uploaded to the bucket (under the `extensions`
  folder as well).

Once all these files are uploaded, you should be ready to finish with the final
configuration of the site.

## cloud-run.tf

The `args` passed to the container need to be updated depending on how many
custom files and directories were added to the bucket. To make this work with a
standard [MediaWiki][2] image, we mount the data bucket in the `/local`
directory. However, that is not where the website looks for files, so we need to
override some of the defaults to make these files visible.

The standard commands for `LocalSettings.php` and `images/` should be relatively
safe to keep, but you may need to ask for further assistance if your
installation has many custom files and extensions.

The other element that would need editing is the version of [MediaWiki][2] you
are currently using. You can find the version by finding the
`RELEASE-NOTES-1.xx` file in your current [MediaWiki][2] directory. That version
should match the `image` value in the `containers` section. For example, for
`1.34` you should have the following `image` line:

```HCL
image = "docker.io/library/mediawiki:1.34"
```

## LocalSettings.php

To get the site working correctly after the container has been launched, the
configuration file will need to be edited. The following modifications should
make the site functional:

### IP setting

At the top of the file, we have to hard-code the path where [MediaWiki][2] is
installed in the container (`$IP`). It should look something like the following
depending on the version of [MediaWiki][2]:

```PHP
if( defined( 'MW_INSTALL_PATH' ) ) {
    $IP = MW_INSTALL_PATH;
} else {
    $IP = '/var/www/html';
}
```

### wgScriptPath

Find the `$wgScriptPath` variable in the file. The current line should be
commented out and replaced with the following three lines:

```PHP
$wgScriptPath = "";
$wgArticlePath = "/$1";
$wgUsePathInfo = true;
```

This will correctly allow the site to work at the root instead of a
subdirectory.

### wgServer

Find the `$wgServer` line and comment it out. This is the URL where this new
site is located. For testing, you can use the Cloud Run URL, which can be found
in the `url` value when running:

```Shell
terraform output
```

The line should look like something similar to the following:

```PHP
$wgServer = "https://mediawiki-1234567890ab.us-east4.run.app";
```

Once you have the permanent domain setup and the load balancer and certificate
are set up, you can change this value. For example:

```PHP
$wgServer = "https://${{ values.applicationDomain }}";
```

### Database settings

The database settings have changed from the original site, so they need to be
updated. Find the `$wgDByype` variable in the file. The setting lines should be
something similar to the following:

```PHP
$wgDBtype           = "mysql";
$wgDBserver         = "localhost:/cloudsql/${{ values.gcpProject }}:${{ values.gcpRegion }}:${{ values.name }}-mediawiki-abcdef123";
$wgDBname           = "mediawiki";
$wgDBuser           = "mediawiki";
$wgDBpassword       = "1234567890abcdefghijklmn";
```

You will need to edit the `$wgDBserver` value to match what you used previously
in the [Cloud SQL Proxy][4] example. You will also need to fetch the database
password the same way you did in the proxy example.

[1]: https://developer.hashicorp.com/terraform "Terraform"
[2]: https://www.mediawiki.org/ "MediaWiki"
[3]: https://cloud.google.com/sql "Google Cloud SQL"
[4]: https://cloud.google.com/sql/docs/mysql/sql-proxy "Cloud SQL Proxy"
